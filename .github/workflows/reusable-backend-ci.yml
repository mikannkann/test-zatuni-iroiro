name: Backend CI

on:
  workflow_call:
  workflow_dispatch:

permissions:
  contents: read

defaults:
  run:
    working-directory: backend

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: 1.24

      - name: Go Mod Tidy
        run: go mod tidy

      - name: Lint (golangci-lint)
        if: ${{ github.event_name != 'pull_request' || !contains(join(github.event.pull_request.labels.*.name, ','), 'skip-lint') }}
        uses: golangci/golangci-lint-action@v8.0.0
        with:
          working-directory: backend

      - name: Skip notice
        if: ${{ github.event_name == 'pull_request' && contains(join(github.event.pull_request.labels.*.name, ','), 'skip-lint') }}
        run: echo "skip-lint を含むラベルが付与されているため golangci-lint をスキップしました"

  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: 1.24

      - name: Dump Go environment and workspace (debug)
        id: go-env
        run: |
          echo "PWD: $(pwd)"
          echo "Listing repo root"
          ls -la
          echo "Listing backend dir"
          ls -la backend || true
          echo "backend/go.sum exists: " $( [ -f backend/go.sum ] && echo yes || echo no )
          echo "go version: $(go version)"
          echo "GOMOD: $(go env GOMOD)"
          echo "GOMODCACHE: $(go env GOMODCACHE)"
          echo "GOCACHE: $(go env GOCACHE)"
          # expose values as step outputs for later steps
          echo "gomodcache=$(go env GOMODCACHE)" >> $GITHUB_OUTPUT
          echo "gocache=$(go env GOCACHE)" >> $GITHUB_OUTPUT

      - name: Debug computed cache key
        run: |
          echo "hashFiles('backend/go.sum') = '${{ hashFiles('backend/go.sum') }}'"
          echo "Computed key: ${{ runner.os }}-go-${{ hashFiles('backend/go.sum') }}"

      - name: Cache Go modules
        id: cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ${{ steps.go-env.outputs.gomodcache }}
          # make hash target explicit to the backend folder
          key: ${{ runner.os }}-go-${{ hashFiles('backend/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Go Mod Tidy
        run: go mod tidy

      - name: Build
        run: go build ./...
