name: Backend CI

on:
  workflow_call:
  workflow_dispatch:

permissions:
  contents: read

defaults:
  run:
    working-directory: backend

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: 1.24

      - name: Go Mod Tidy
        run: go mod tidy

      - name: Lint (golangci-lint)
        if: ${{ github.event_name != 'pull_request' || !contains(join(github.event.pull_request.labels.*.name, ','), 'skip-lint') }}
        uses: golangci/golangci-lint-action@v8.0.0
        with:
          working-directory: backend

      - name: Skip notice
        if: ${{ github.event_name == 'pull_request' && contains(join(github.event.pull_request.labels.*.name, ','), 'skip-lint') }}
        run: echo "skip-lint を含むラベルが付与されているため golangci-lint をスキップしました"

  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: 1.24

      - name: Dump Go environment and workspace (debug)
        id: go-env
        run: |
          echo "PWD: $(pwd)"
          echo "Listing repo root"
          ls -la .. || true
          echo "Listing current dir"
          ls -la || true
          echo "go version: $(go version)"
          echo "GOMOD: $(go env GOMOD)"
          echo "GOMODCACHE: $(go env GOMODCACHE)"
          echo "GOCACHE: $(go env GOCACHE)"
          echo "gomodcache=$(go env GOMODCACHE)" >> $GITHUB_OUTPUT
          echo "gocache=$(go env GOCACHE)" >> $GITHUB_OUTPUT

      - name: Go Mod Tidy
        run: go mod tidy

      - name: Debug computed cache key
        run: |
          echo "hashFiles('backend/go.sum') = '${{ hashFiles('backend/go.sum') }}'"
          echo "hashFiles('**/go.sum') = '${{ hashFiles('**/go.sum') }}'"
          echo "Computed key (backend): ${{ runner.os }}-go-${{ hashFiles('backend/go.sum') }}"

      - name: List GOMODCACHE before caching (debug)
        run: |
          echo "GOMODCACHE = ${{ steps.go-env.outputs.gomodcache }}"
          if [ -d "${{ steps.go-env.outputs.gomodcache }}" ]; then
            echo "Listing top-level of GOMODCACHE"
            ls -la "${{ steps.go-env.outputs.gomodcache }}" | head -n 50 || true
            echo "Count files:"
            find "${{ steps.go-env.outputs.gomodcache }}" -maxdepth 2 -type f | wc -l || true
          else
            echo "GOMODCACHE dir does not exist"
          fi

      - name: Cache Go modules
        id: cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ${{ steps.go-env.outputs.gomodcache }}
          key: ${{ runner.os }}-go-${{ hashFiles('backend/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Build
        run: go build ./...
